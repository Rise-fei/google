<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <link rel="shortcut icon" href="/static/img/favicon.ico"/>

    <script type="text/javascript" src="/static/js/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="/static/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <script type="text/javascript" src="/static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

    <link href='http://www.bigemap.com:9000/bigemap.js/v2.1.0/bigemap.css' rel='stylesheet'/>
    <link href='http://47.244.57.68:9000/bigemap.js/v2.1.0/bigemap.css' rel='stylesheet'/>
    <link rel='stylesheet' href='/static/css/bigemap.css'/>
    <script src='http://47.244.57.68:9000/bigemap.js/v2.1.0/bigemap.js'></script>

    <title>GMS外贸系统</title>
</head>
<body>


<div id="main_content">
    <nav class="navbar navbar-inverse" style="z-index: 10">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <a class="navbar-brand" href="http://sstrade.net/">晟时科技</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="#">Link</a></li>
                    <li><a href="#">Link</a></li>
                    <li><a href="#">Link</a></li>
                    <li><a href="#">Link</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#">当前用户</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                           aria-expanded="false">{{ request.session.username }} <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            {#            <li><a href="#">Action</a></li>#}

                            {#            <li role="separator" class="divider"></li>#}
                            <li><a href="/logout/">注销</a></li>
                        </ul>
                    </li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>
    <div style="height: 552px;position: relative;z-index: 8">
        <p class="tool">
            <a id="satellite" class="btn btn-danger" href="javascript:void (0);">卫星</a>
            <a id="street" class="btn btn-warning" href="javascript:void (0);">电子</a>
        </p>
        <div id='map'></div>
        <div id="info">
            <button id="search_button2" class="btn btn-primary search—btn">附近查询</button>
            <button id="search_button" class="btn btn-info search—btn">具体查询</button>
            <input type="text" id="pac-input" placeholder="请输入要查询的关键字">
            <select id="select_meter">
                <option value="100">周围100米</option>
                <option value="500">周围500米</option>
                <option value="1000">周围1公里</option>
                <option value="5000">周围5公里</option>
                <option value="10000">周围10公里</option>
                <option selected value="50000">周围50公里</option>
            </select>
            <div id="result">

            </div>
        </div>

    </div>

    {% csrf_token %}
    <div>
        <table id="table-content" class="table table-bordered" style="z-index: 5;table-layout: fixed">
            <thead>
            <th>名称</th>
            <th>网址</th>
            <th>email</th>
            <th>类型</th>
            <th>地址</th>
            <th>电话</th>
            <th>Facebook</th>
            <th>Youtube</th>
            <th>Twitter</th>
            <th>搜索关键字</th>
            </thead>
            <tbody id="table_content">

            </tbody>
        </table>
    </div>

</div>

<script>

    //软件配置信息地址
    BM.Config.HTTP_URL = 'http://47.244.57.68:9000';
    // 在ID为map的元素中实例化一个地图，并设置地图的ID号为 bigemap.googlemap-streets，ID号程序自动生成，无需手动配置，并设置地图的投影为百度地图 ，中心点，默认的级别和显示级别控件
    var map = BM.map('map', 'bigemap.googlemap-streets', {center: [0, 0], zoom: 2, zoomControl: true, minZoom: 2});
    // 创建一个标记，添加到map中
    {#var corner1 = BM.latLng(-180, 90);#}
    {#var corner2 = BM.latLng(180, -90);#}
    {#var bounds = BM.latLngBounds(corner1, corner2);#}
    {#map.setMaxBounds(bounds)#}

    var google_satellite = BM.tileLayer('bigemap.googlemap-satellite');
    var google_street = BM.tileLayer('bigemap.googlemap-streets');
    document.getElementById('satellite').addEventListener('click', function () {
        //先移除一个图层 ，再添加一个图层
        google_satellite.addTo(map);
        google_street.remove(map);
    });

    document.getElementById('street').addEventListener('click', function () {
        google_satellite.remove(map);
        google_street.addTo(map);
    });


    // 创建一个经纬度对象
    var latlng = BM.latLng(40, 116.5);
    var marker = BM.marker(latlng);
    marker.addTo(map);
    // 创建一个圆对象，指定位置和半径，并添加到map
    var circle = BM.circle(latlng, {radius: 50000})
    circle.addTo(map);
    map.panTo(latlng);
    BM.control.scale().addTo(map);

    map.on('click', function (e) {
        // 获取当前点击的坐标，设置标记和地图为点击位置。
        var position_temp = e.latlng;
        marker.setLatLng(position_temp);
        map.setView(position_temp);

        var radius = parseInt(document.getElementById('select_meter').value);
        circle.setRadius(radius);
        circle.setLatLng(position_temp);
    });
    map.on('moveend', function (e) {
        window.setTimeout(function () {
            var div_size_y = map.getSize().y
            var top_y = map.getPixelBounds().max.y
            var bottom_y = map.getPixelBounds().min.y
            var sw_positon = map.getBounds()._southWest
            var ne_postion = map.getBounds()._northEast
            var bottom_yy = map.latLngToContainerPoint(map.getBounds()._southWest).y
            console.log(div_size_y, top_y, bottom_y,top_y-bottom_y);
            var flag = (top_y < div_size_y || bottom_yy  < div_size_y);
            if (flag) {
                console.log(11111111111);
                map.flyTo(marker.getLatLng())
            }
        }, 2)
        // 获取当前点击的坐标，设置标记和地图为点击位置。
    });


    marker.on('click', function (e) {
        window.setTimeout(function () {
            map.setZoom(8);
            map.panTo(marker.getLatLng())
        }, 500)
    });


    marker.on('move', function (e) {
        map.panTo(marker.getLatLng())
    })
    // 通过control将搜索框添加到map


</script>
<script>
    $.ajaxSetup({

        async: false

    });

    function click_a() {
        $('.search_result_name').click(function () {
            var lat = $(this).attr('lat');
            var lng = $(this).attr('lng');
            marker.setLatLng({lat: lat, lng: lng})
        })
    }

    function get_search_list(datas, data_html) {
        $('#table_content').append(data_html);
        click_a();
    }


    $(function () {
        $('#select_meter').change(function () {
            {#alert(1);#}
            var radius = parseInt($('#select_meter').val());
            {#circle.setCenter(marker.getPosition())#}
            circle.setRadius(radius);
        })

        $('#search_button').click(function () {
            alert('正在进行精准搜索！')
            alert('请耐心等待，画面即将锁定！')
            var position = marker.getLatLng();
            var current_lat = position.lat;
            var current_lng = position.lng;
            var word = $('#pac-input').val();
            var radius = $('#select_meter').val();
            $.ajax({
                url: '/search_word/',
                type: 'post',
                data: {
                    'word': word,
                    'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                    'lat': current_lat,
                    'lng': current_lng,
                    'radius': radius,
                },
                success: function (ret) {
                    if (ret.status == 1) {
                        //搜索到具体位置了
                        var data = ret.data
                        var formatted_address = data.result.formatted_address
                        var formatted_phone_number = data.result.formatted_phone_number
                        var location = data.result.geometry.location;
                        var name = data.result.name;
                        alert('找到具体位置!');
                        console.log(location)

                        marker.setLatLng(location);
                        circle.setLatLng(location);
                        $('#table_content').append(ret.data_html);
                        click_a();


                    } else if (ret.status == 0) {
                        alert('查询到附近相关结果');
                        var datas = ret.data.results;
                        var data_html = ret.data_final_html;
                        console.log(datas);
                        get_search_list(datas, data_html)

                    } else {
                        alert('no data!')
                    }
                }
            })
        });
        $('#search_button2').click(function () {
            alert('正在进行搜索附近！')
            alert('请耐心等待，画面即将锁定！')
            var position = marker.getLatLng();
            var current_lat = position.lat;
            var current_lng = position.lng;
            var word = $('#pac-input').val();
            var radius = $('#select_meter').val();
            $.ajax({
                url: '/search_word2/',
                type: 'post',
                data: {
                    'word': word,
                    'radius': radius,
                    'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val(),
                    'lat': current_lat,
                    'lng': current_lng,
                },
                success: function (ret) {
                    if (ret.status == 0) {
                        alert('查询到附近相关结果');
                        var datas = ret.data.results;
                        var data_html = ret.data_final_html;
                        console.log(datas);
                        get_search_list(datas, data_html)

                    } else {
                        alert('未查询到附近相关结果!')
                    }
                }
            })
        });

    })
</script>
</body>

{#<script>#}
{#    window.onbeforeunload = onunload_message;#}
{##}
{#    function onunload_message(event) {#}
{#        if (event.clientX > document.body.clientWidth && event.clientY < 0 || event.altKey) {#}
{#            //鼠标相对于用户屏幕的水平位置 - 窗口左上角相对于屏幕左上角的水平位置 = 鼠标在当前窗口上的水平位置#}
{#            var n = event.screenX - window.screenLeft;#}
{#            //鼠标在当前窗口内时，n<m，b为false；鼠标在当前窗口外时，n>m，b为true。20这个值是指关闭按钮的宽度#}
{#            var b = n > document.documentElement.scrollWidth - 20;#}
{#            //鼠标在客户区内时，window.event.clientY>0；鼠标在客户区外时，window.event.clientY<0#}
{#            if (b && event.clientY < 0 || event.altKey || event.ctrlKey) {#}
{#                console.log(11111111111111)#}
{#            } else if (event.clientY > document.body.clientHeight || event.altKey) {#}
{##}
{#                console.log(123456)#}
{#            }#}
{#            $(function () {#}
{##}
{#                $.ajax({#}
{#                    url: '/close_page/',#}
{#                    type: 'get',#}
{#                    success: function (ret) {#}
{##}
{#                    }#}
{#                })#}
{#            })#}
{#        }#}
{##}
{##}
{#        return "您确定离开该网页吗？";#}
{#    }#}
{#</script>#}
</html>